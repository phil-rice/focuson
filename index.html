<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>One file no compilation react app</title>
    <LINK href="index.css" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script type="text/javascript" src="src/reactRest.js"></script>
    <script type="text/javascript" src="node_modules/crypto-js/crypto-js.js"></script>

</head>
<body>
<noscript>You need to enable JavaScript to run this app.</noscript>
<div id="root"></div>

<script>
    //This would normally be 'go get that string from the backend' Here we are hard coding it to allow us to focus on the rendering
    var gameCode = `class Game extends React.Component {
    constructor(props) {
        super(props);
        this.state = props.data._embedded.board
        console.log("creating game", this.state)
        this.reactRest = this.props.reactRest
    }

    render() {
        console.log("rendering game0", this.state)
        const e = React.createElement;
        let board = this.reactRest.renderSelf(this.state)
        console.log("in rendering game", board)
        return (
            e("div", {className: "game"}, e("div", {className: "game-board"}, board),
                e("div", {className: "game-info"},
                    e("div", null),
                    e("ol", null)))
        )
    }
}

Game
 `
    let boardCode = `const e = React.createElement;

class Board extends React.Component {
    constructor(props) {
        super(props);
        console.log("Board.props", props)
        this.reactRest = props.reactRest
        this.state = {squares: props.data.squares, xIsNext: true}
        console.log("creating board with", this.state)
    }

    renderSquare(i) {
        return this.reactRest.renderUsing('square', {
            index: i,
            value: this.state.squares[i],
            onClick: () => this.handleClick(i)
        })
    }

    next() {
        return this.state.xIsNext ? 'X' : 'O'
    }

    handleClick(i) {
        const squares = this.state.squares.slice();
        squares[i] = this.next()
        this.setState({squares: squares, xIsNext: !this.state.xIsNext});
    }

    render() {
        console.log("rnedering board", this.state)

        const status = 'Next player: ' + this.next();
        return (
            e("div", null, e("div", {className: "status"}, status),
                e("div", {className: "board-row"}, this.renderSquare(0), this.renderSquare(1), this.renderSquare(2)),
                e("div", {className: "board-row"}, this.renderSquare(3), this.renderSquare(4), this.renderSquare(5)),
                e("div", {className: "board-row"}, this.renderSquare(6), this.renderSquare(7), this.renderSquare(8)))
        )
    }
}

Board
`
    var squareCode = `const e = React.createElement;

function Square(props) {
    return e("button", {className: "square", onClick: () => props.data.onClick()}, props.data.value);
}
Square
`
    var square2Code = `const e = React.createElement;

function Square2(props) {
    return e("button", {className: "square", onClick: () => props.data.onClick()}, props.data.value + "x");
}
Square2
`

    let gameUrl = "https://someDomain/api/game/render/" + CryptoJS.SHA256(gameCode)
    let boardUrl = "https://someDomain/api/board/render/" + CryptoJS.SHA256(boardCode)
    let squareUrl = "https://someDomain/api/square/render/" + CryptoJS.SHA256(squareCode)
    let square2Url = "https://someDomain/api/square/render/" + CryptoJS.SHA256(square2Code)


    // let squareClassFromApi = eval(squareCode)
    // let boardClassFromApi = eval(boardCode)
    // let gameClassFromApi = eval(gameCode)

    let classMap = []
    classMap[gameUrl] = gameCode
    classMap[boardUrl] = boardCode
    classMap[squareUrl] = squareCode
    classMap[square2Url] = square2Code

    function loader(url) {
        return Promise.resolve(classMap[url])
    }
</script>

<script>
    var cache = new ReactRestCache(loader, CryptoJS.SHA256)

    function renderIt(json, element) {
        return cache.loadFromBlob(json).then(theyAreLoaded => {
                let reactComponentClass = new ReactRest(React.createElement, cache).renderSelf(json);
                console.log("renderIt", reactComponentClass, json)
                return ReactDOM.render(reactComponentClass, element)
            }
        )
    }
</script>

<script>
    let gameJson = {
        _links: {_self: {href: "someUrl/For/This/Game"}},
        _render: {_self: gameUrl},
        gameData: 'Some game data properties could go here',
        _embedded: {
            board: {
                _links: {_self: {href: "someUrl/For/The/Board"}},
                _render: {_self: boardUrl, square: squareUrl},
                squares: [1, 2, 3, 4, 5, 6, 7, 8, 9]
            }
        }
    }
    let game2Json = {
        _links: {_self: {href: "someUrl/For/This/Game"}},
        _render: {_self: gameUrl},
        gameData: 'Some game data properties could go here',
        _embedded: {
            board: {
                _links: {_self: {href: "someUrl/For/The/Board"}},
                _render: {_self: boardUrl, square: square2Url},
                squares: [1, 2, 3, 4, 5, 6, 7, 8, 9]
            }
        }
    }


    function startGame() {
        console.log("restartGame")
        var result = renderIt(gameJson, document.getElementById('root'))
        result.then(r => console.log("resultOfRestartGame", r))
        return result
    }

    console.log(findAllRenderUrls(gameJson))
    var gamePromise = startGame()

    function changeGameRendering(json) {
        console.log("renderUrls", findAllRenderUrls(json))
        cache.loadFromBlob(json)
        gamePromise.then(game => game.setState(json))
    }
</script>
<ul>
    <li>
        <button onclick="changeGameRendering(gameJson)">Restart1</button>
    </li>
    <li>
        <button onclick="changeGameRendering(game2Json)">Restart2</button>
    </li>
</ul>
</body>
</html>
